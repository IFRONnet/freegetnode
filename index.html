<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <!-- 头部内容 -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>公益免费订阅</title>
    <!-- 引入更具现代感的字体 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- 引入 Poppins 字体并优化字体加载 -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- 引入动画库 -->
    <style>
        :root {
            /* 定义颜色和动画变量 */
            --primary-color: #00b4db;
            --secondary-color: #0083b0;
            --background-gradient: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            --text-color: #ffffff;
            --accent-color: #f5af19;
            --error-color: #ff4d4d;
            --success-color: #4dff4d;
            --info-color: #00e6ff;
            --animation-duration: 0.8s;
            --animation-ease: cubic-bezier(0.4, 0.0, 0.2, 1);
        }

        /* 全局样式 */
        *,
        *::before,
        *::after {
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 0;
            background: var(--background-gradient);
            color: var(--text-color);
            overflow-x: hidden;
            animation: fadeIn var(--animation-duration) var(--animation-ease) forwards;
            will-change: opacity;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        h1 {
            color: var(--primary-color);
            text-align: center;
            margin: 40px 20px 20px 20px;
            font-size: 3.5rem;
            text-shadow: 0 0 15px var(--primary-color), 0 0 25px var(--primary-color);
            animation: slideDown var(--animation-duration) var(--animation-ease) forwards;
            will-change: transform, opacity;
        }

        @keyframes slideDown {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .message-container {
            max-width: 800px;
            width: 90%;
            margin: 20px auto;
            padding: 10px;
            text-align: center;
            position: fixed; /* 固定在页面顶部 */
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000; /* 确保提示框在最前面 */
        }

        .message {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 20px;
            border-radius: 50px;
            margin-bottom: 10px;
            font-size: 1rem;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(5px);
            opacity: 0;
            animation: fadeInUp var(--animation-duration) var(--animation-ease) forwards;
            will-change: transform, opacity;
            transition: opacity 0.5s ease, transform 0.5s ease;
            position: relative;
        }

        @keyframes fadeInUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .message.info {
            border-left: 5px solid var(--info-color);
        }

        .message.error {
            border-left: 5px solid var(--error-color);
        }

        .message.success {
            border-left: 5px solid var(--success-color);
        }

        /* 关闭按钮样式 */
        .message .close-btn {
            background: transparent;
            border: none;
            color: var(--text-color);
            font-size: 1.2rem;
            cursor: pointer;
            margin-left: 15px;
            transition: color 0.3s;
        }

        .message .close-btn:hover {
            color: #ccc;
        }

        .container {
            max-width: 800px;
            width: 90%;
            margin: 50px auto;
            padding: 30px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            opacity: 0;
            animation: fadeIn var(--animation-duration) var(--animation-ease) forwards 0.2s;
            will-change: opacity;
        }

        .content {
            font-size: 1.2rem;
            line-height: 1.8;
            color: #e0e0e0;
            margin-bottom: 20px;
            opacity: 0;
            animation: fadeIn var(--animation-duration) var(--animation-ease) forwards 0.4s;
            will-change: opacity;
        }

        .progress-container {
            margin: 30px 0;
            opacity: 0;
            animation: fadeInUp var(--animation-duration) var(--animation-ease) forwards 0.6s;
            will-change: transform, opacity;
        }

        .progress-bar {
            width: 100%;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            overflow: hidden;
            height: 30px;
            position: relative;
        }

        .progress-bar-inner {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            width: 0%;
            text-align: center;
            color: #ffffff;
            line-height: 30px;
            text-shadow: 0 0 8px #000;
            border-radius: 10px;
            transition: width 1s var(--animation-ease), background 0.3s;
            will-change: width, background;
        }

        .btn {
            padding: 15px 40px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.3s, box-shadow 0.3s, transform 0.2s;
            display: inline-block;
            text-align: center;
            margin-top: 20px;
            text-decoration: none;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            margin-right: 10px;
            opacity: 0;
            animation: fadeInUp var(--animation-duration) var(--animation-ease) forwards 0.8s;
            position: relative;
            overflow: hidden;
            will-change: transform, opacity;
        }

        .btn::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.2);
            transform: skewX(-45deg);
            transition: left 0.5s var(--animation-ease);
            will-change: left;
        }

        .btn:hover::after {
            left: 100%;
        }

        .btn:hover {
            background: var(--secondary-color);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
            transform: translateY(-3px);
        }

        .btn:active {
            transform: scale(0.97);
            transition: transform 0.1s var(--animation-ease);
        }

        .button-group {
            display: flex;
            flex-direction: row;
            justify-content: center;
            gap: 10px; /* 使用 gap 代替 margin-right */
            text-align: center;
        }

        /* 新增：分类和节点样式 */
        .categories {
            margin-top: 30px;
        }

        .category {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            margin-bottom: 15px;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .category-header {
            padding: 15px 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 180, 219, 0.2);
        }

        .category-header:hover {
            background: rgba(0, 180, 219, 0.3);
        }

        .category-header h2 {
            margin: 0;
            font-size: 1.2rem;
            color: var(--text-color);
        }

        .category-header .toggle-icon {
            font-size: 1.5rem;
            transition: transform 0.3s ease;
        }

        .category.collapsed .toggle-icon {
            transform: rotate(-90deg);
        }

        .category-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .category.expanded .category-content {
            max-height: 1000px; /* 足够大的值以显示所有内容 */
        }

        .node {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.05);
        }

        .node:nth-child(even) {
            background: rgba(255, 255, 255, 0.1);
        }

        .node-name {
            font-size: 1rem;
            color: #e0e0e0;
        }

        .copy-btn {
            padding: 5px 15px;
            background: var(--accent-color);
            color: #fff;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.3s;
        }

        .copy-btn:hover {
            background: darkorange;
        }

        /* 响应式设计 */
        @media (max-width: 600px) {
            h1 {
                font-size: 2.5rem;
            }
            .content {
                font-size: 1rem;
                line-height: 1.6;
            }
            .btn {
                font-size: 0.9rem;
                padding: 12px 30px;
                min-height: 45px;
                width: 100%; /* 按钮宽度占满父容器 */
            }
            .progress-bar {
                height: 25px;
            }
            .progress-bar-inner {
                line-height: 25px;
            }
            .container {
                padding: 20px;
            }
            .button-group {
                flex-direction: column; /* 在小屏设备上垂直排列 */
                gap: 10px;
            }
            .message-container {
                top: 10px;
                max-width: 90%;
            }

            /* 新增：分类和节点样式适配 */
            .category-header h2 {
                font-size: 1rem;
            }

            .copy-btn {
                font-size: 0.8rem;
                padding: 5px 10px;
            }
        }
    </style>
</head>
<body>

<h1>公益免费订阅</h1>

<div class="message-container" id="messageContainer"></div>

<div class="container">
    <div class="content" id="dataContainer">
        <p>正在加载用户参数，请稍候...</p>
    </div>

    <div class="progress-container">
        <div class="progress-bar">
            <div class="progress-bar-inner" id="trafficProgressBar">0%</div>
        </div>
    </div>

    <div class="button-group">
        <button class="btn" id="copySubscriptionBtn">复制订阅内容</button>
        <button class="btn" id="refreshDataBtn">刷新数据</button>
    </div>

    <!-- 新增：分类和节点展示 -->
    <div class="categories" id="categoriesContainer">
        <!-- 分类将动态添加到这里 -->
    </div>
</div>

<script>
    const uuid = '88888888-8888-8888-8888-888888888888';
    const mainDomain = 'https://getfreenodes.com';
    const backupDomain = 'https://getafreenode.com';

    const mainApiUrl = `${mainDomain}/main/web_api.php?act=getuserinfo&uuid=${uuid}`;
    const backupApiUrl = `${backupDomain}/main/web_api.php?act=getuserinfo&uuid=${uuid}`;
    const mainSubscriptionUrl = `${mainDomain}/subscribe/?uuid=${uuid}`;
    const backupSubscriptionUrl = `${backupDomain}/subscribe/?uuid=${uuid}`;

    const corsProxy = 'https://api.allorigins.win/get?url=';
    let finalBase64 = ''; // 用于保存生成的 Base64 订阅内容

    // 显示消息
    function showMessage(message, type = 'info') {
        const messageContainer = document.getElementById('messageContainer');
        const messageElement = document.createElement('div');
        messageElement.className = `message ${type}`;
        messageElement.innerHTML = `
            <span>${message}</span>
            <button class="close-btn" aria-label="关闭消息">&times;</button>
        `;
        messageContainer.appendChild(messageElement);

        // 关闭按钮事件
        const closeBtn = messageElement.querySelector('.close-btn');
        closeBtn.addEventListener('click', () => {
            closeMessage(messageElement);
        });

        // 自动隐藏消息
        setTimeout(() => {
            closeMessage(messageElement);
        }, 3000); // 3秒后自动关闭
    }

    // 关闭消息
    function closeMessage(messageElement) {
        if (messageElement) {
            messageElement.style.opacity = '0';
            messageElement.style.transform = 'translateY(-20px)';
            // 使用 setTimeout 确保动画完成后移除元素
            setTimeout(() => {
                if (messageElement.parentNode) {
                    messageElement.parentNode.removeChild(messageElement);
                }
            }, 500); // 与CSS中的transition时间一致
        }
    }

    // 带有超时功能的 fetch
    function fetchWithTimeout(url, options = {}, timeout = 5000) {
        return new Promise((resolve, reject) => {
            const timer = setTimeout(() => {
                reject(new Error('请求超时'));
            }, timeout);

            fetch(url, { ...options, cache: 'no-store' }) // 添加 cache: 'no-store'
                .then(response => {
                    clearTimeout(timer);
                    resolve(response);
                })
                .catch(err => {
                    clearTimeout(timer);
                    reject(err);
                });
        });
    }

    // 从多个 URL 尝试获取数据，带有重试逻辑
    async function fetchDataFromUrlsWithRetries(urls, retriesPerUrl, retryInterval, timeout) {
        for (let i = 0; i < urls.length; i++) {
            const url = urls[i];
            const apiName = i === 0 ? '主' : '备用';
            for (let attempt = 1; attempt <= retriesPerUrl; attempt++) {
                try {
                    const response = await fetchWithTimeout(url, {}, timeout);
                    if (!response.ok) throw new Error('网络响应不正常');
                    const data = await response.json();
                    return data;
                } catch (error) {
                    showMessage(`从${apiName} API 获取数据失败，重试 ${attempt}/${retriesPerUrl} 次...`, 'error');
                    if (attempt < retriesPerUrl) {
                        await new Promise(resolve => setTimeout(resolve, retryInterval));
                    }
                }
            }
        }
        throw new Error('所有 API 尝试均失败');
    }

    // 获取用户数据
    async function fetchUserData() {
        const urls = [
            corsProxy + encodeURIComponent(mainApiUrl) + `&timestamp=${new Date().getTime()}`,
            corsProxy + encodeURIComponent(backupApiUrl) + `&timestamp=${new Date().getTime()}`
        ];
        try {
            const data = await fetchDataFromUrlsWithRetries(urls, 10, 10000, 5000);
            displayData(JSON.parse(data.contents));
        } catch (error) {
            showMessage('获取用户数据失败，请稍后再试。', 'error');
        }
    }

    // 获取订阅信息
    async function fetchSubscriptionInfo() {
        const urls = [
            corsProxy + encodeURIComponent(mainSubscriptionUrl) + `&timestamp=${new Date().getTime()}`,
            corsProxy + encodeURIComponent(backupSubscriptionUrl) + `&timestamp=${new Date().getTime()}`
        ];
        try {
            const data = await fetchDataFromUrlsWithRetries(urls, 10, 10000, 5000);
            const decodedContent = atob(data.contents); // Base64 解码
            finalBase64 = generateFinalBase64(decodedContent);
        } catch (error) {
            showMessage('获取订阅信息失败，请稍后再试。', 'error');
        }
    }

    // 显示用户数据
    function displayData(data) {
        const dataContainer = document.getElementById('dataContainer');
        const percent = data.percentNumber;

        dataContainer.innerHTML = `
            <div class="content"><strong>订阅最后使用时间：</strong> ${new Date(data.lastUseTime * 1000).toLocaleString()}</div>
            <div class="content"><strong>订阅速度最大限制：</strong> ${data.speedlimit} Mbps</div>
            <div class="content"><strong>当前订阅剩余流量：</strong> ${data.remainingTraffic}</div>
            <div class="content"><strong>已用流量的百分比：</strong> ${percent}%</div>
            <div class="content"><strong>已自动重置的次数：</strong> ${data.resetTimes}</div>
        `;

        // 重新触发内容的动画
        const contents = dataContainer.querySelectorAll('.content');
        contents.forEach((content, index) => {
            content.style.opacity = '0';
            content.style.animation = `fadeIn var(--animation-duration) var(--animation-ease) forwards ${0.2 + index * 0.1}s`;
        });

        // 更新进度条
        const progressBar = document.getElementById('trafficProgressBar');
        setTimeout(() => {
            progressBar.style.width = percent + '%';
            progressBar.textContent = percent + '%';
            // 根据使用百分比改变进度条颜色
            if (percent > 80) {
                progressBar.style.background = 'red';
            } else if (percent > 50) {
                progressBar.style.background = 'orange';
            } else {
                progressBar.style.background = 'green';
            }
        }, 800);
    }

    // 生成最终 Base64 编码
    function generateFinalBase64(decodedContent) {
        const lines = decodedContent.split('\n').map(line => {
            if (line.startsWith('vmess://')) {
                const vmessDecoded = atob(line.slice(8)); // 去掉 'vmess://' 并解码 Base64
                const vmessReplaced = replaceKeywords(vmessDecoded); // 替换广告内容
                return 'vmess://' + btoa(vmessReplaced); // 重新编码为 Base64 并加上 'vmess://'
            } else {
                return replaceKeywords(line); // 对其他类型的链接进行广告替换
            }
        }).join('\n');
        return btoa(lines); // 将处理后的内容重新编码为 Base64
    }

    // 替换广告关键词
    function replaceKeywords(text) {
        return text.replace(/-GetAFreeNode\.com/g, '-getfreenode.pages.dev/')
                   .replace(/-GetAFreeNode/g, '-getfreenode.pages.dev/');
    }

    // 复制订阅内容
    document.getElementById('copySubscriptionBtn').addEventListener('click', function() {
        if (finalBase64) {
            navigator.clipboard.writeText(finalBase64).then(() => {
                showMessage('订阅内容已复制到剪贴板', 'success');
            }).catch(err => {
                showMessage('复制失败，请重试', 'error');
            });
        } else {
            showMessage('订阅内容尚未加载，请稍后再试', 'error');
        }
    });

    // 刷新数据
    document.getElementById('refreshDataBtn').addEventListener('click', function() {
        fetchUserData();
        fetchSubscriptionInfo();
    });

    // 页面加载时调用
    window.onload = function() {
        fetchUserData();
        fetchSubscriptionInfo();
    };

    // 新增：显示分类和节点
    function displayCategories(categories) {
        const categoriesContainer = document.getElementById('categoriesContainer');
        categoriesContainer.innerHTML = ''; // 清空现有内容

        categories.forEach((category, catIndex) => {
            // 创建分类元素
            const categoryElement = document.createElement('div');
            categoryElement.className = 'category collapsed';

            // 创建分类头部
            const categoryHeader = document.createElement('div');
            categoryHeader.className = 'category-header';
            categoryHeader.innerHTML = `
                <h2>${category.name}</h2>
                <span class="toggle-icon">&#9654;</span>
            `;
            categoryElement.appendChild(categoryHeader);

            // 创建分类内容
            const categoryContent = document.createElement('div');
            categoryContent.className = 'category-content';

            category.nodes.forEach((node, nodeIndex) => {
                const nodeElement = document.createElement('div');
                nodeElement.className = 'node';
                nodeElement.innerHTML = `
                    <span class="node-name">${node.name}</span>
                    <button class="copy-btn" data-content="${node.content}">复制</button>
                `;
                categoryContent.appendChild(nodeElement);
            });

            categoryElement.appendChild(categoryContent);
            categoriesContainer.appendChild(categoryElement);

            // 添加事件监听器以展开/折叠分类
            categoryHeader.addEventListener('click', () => {
                categoryElement.classList.toggle('expanded');
                categoryElement.classList.toggle('collapsed');
            });
        });

        // 添加复制按钮的事件监听器
        const copyButtons = document.querySelectorAll('.copy-btn');
        copyButtons.forEach(button => {
            button.addEventListener('click', () => {
                const content = button.getAttribute('data-content');
                navigator.clipboard.writeText(content).then(() => {
                    showMessage('节点内容已复制到剪贴板', 'success');
                }).catch(err => {
                    showMessage('复制失败，请重试', 'error');
                });
            });
        });
    }

    // 假设从 API 获取的额外数据包含分类和节点信息
    // 这里添加一个模拟的 displayCategories 调用，您需要根据实际 API 数据进行调整
    // 在 displayData 函数中添加调用
    function displayData(data) {
        const dataContainer = document.getElementById('dataContainer');
        const percent = data.percentNumber;

        dataContainer.innerHTML = `
            <div class="content"><strong>订阅最后使用时间：</strong> ${new Date(data.lastUseTime * 1000).toLocaleString()}</div>
            <div class="content"><strong>订阅速度最大限制：</strong> ${data.speedlimit} Mbps</div>
            <div class="content"><strong>当前订阅剩余流量：</strong> ${data.remainingTraffic}</div>
            <div class="content"><strong>已用流量的百分比：</strong> ${percent}%</div>
            <div class="content"><strong>已自动重置的次数：</strong> ${data.resetTimes}</div>
        `;

        // 重新触发内容的动画
        const contents = dataContainer.querySelectorAll('.content');
        contents.forEach((content, index) => {
            content.style.opacity = '0';
            content.style.animation = `fadeIn var(--animation-duration) var(--animation-ease) forwards ${0.2 + index * 0.1}s`;
        });

        // 更新进度条
        const progressBar = document.getElementById('trafficProgressBar');
        setTimeout(() => {
            progressBar.style.width = percent + '%';
            progressBar.textContent = percent + '%';
            // 根据使用百分比改变进度条颜色
            if (percent > 80) {
                progressBar.style.background = 'red';
            } else if (percent > 50) {
                progressBar.style.background = 'orange';
            } else {
                progressBar.style.background = 'green';
            }
        }, 800);

        // 假设数据中包含 categories
        if (data.categories && Array.isArray(data.categories)) {
            displayCategories(data.categories);
        } else {
            // 如果没有分类数据，可以显示一个默认消息或处理方式
            const categoriesContainer = document.getElementById('categoriesContainer');
            categoriesContainer.innerHTML = '<p class="content">暂无节点分类信息。</p>';
        }
    }

    // 修改 fetchUserData 和 fetchSubscriptionInfo 来获取分类和节点信息
    // 具体实现取决于您的 API 返回的数据结构
    // 这里只是一个示例，假设分类信息包含在订阅信息中
    async function fetchSubscriptionInfo() {
        const urls = [
            corsProxy + encodeURIComponent(mainSubscriptionUrl) + `&timestamp=${new Date().getTime()}`,
            corsProxy + encodeURIComponent(backupSubscriptionUrl) + `&timestamp=${new Date().getTime()}`
        ];
        try {
            const data = await fetchDataFromUrlsWithRetries(urls, 10, 10000, 5000);
            const decodedContent = atob(data.contents); // Base64 解码
            finalBase64 = generateFinalBase64(decodedContent);

            // 假设 decodedContent 包含分类和节点信息的 JSON 字符串
            // 需要根据实际情况调整
            const subscriptionData = JSON.parse(decodedContent);
            if (subscriptionData.categories) {
                displayCategories(subscriptionData.categories);
            } else {
                showMessage('订阅信息中缺少分类数据。', 'error');
            }
        } catch (error) {
            showMessage('获取订阅信息失败，请稍后再试。', 'error');
        }
    }

    // 示例数据结构（仅供参考）
    /*
    {
        "lastUseTime": 1697049600,
        "speedlimit": 100,
        "remainingTraffic": "500GB",
        "percentNumber": 75,
        "resetTimes": 3,
        "categories": [
            {
                "name": "节点分类1",
                "nodes": [
                    { "name": "节点1", "content": "vmess://..." },
                    { "name": "节点2", "content": "vmess://..." }
                ]
            },
            {
                "name": "节点分类2",
                "nodes": [
                    { "name": "节点3", "content": "vmess://..." },
                    { "name": "节点4", "content": "vmess://..." }
                ]
            }
        ]
    }
    */
</script>

</body>
</html>
