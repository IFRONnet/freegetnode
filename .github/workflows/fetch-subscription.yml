name: Fetch Subscription

on:
  schedule:
    - cron: '0 0 * * *'  # 每天 UTC 00:00 运行（相当于北京时间 08:00）
  workflow_dispatch:      # 允许手动触发

jobs:
  fetch-and-update:
    runs-on: ubuntu-latest
    permissions:          # 添加权限配置
      contents: write     # 给予写入权限
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}  # 使用 GitHub Token
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: Create fetch script
        run: |
          cat > fetch.js << 'EOF'
          const https = require('https');
          const fs = require('fs');
          const path = require('path');

          const CONFIG = {
              uuid: '88888888-8888-8888-8888-888888888888',
              domains: [
                  'https://getfreenodes.com',
                  'https://getafreenode.com'
              ],
              outputDir: 'public/subscribe',
              outputFile: 'subscription.txt',
              userAgent: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36'
          };

          function fetch(url) {
              return new Promise((resolve, reject) => {
                  const options = {
                      headers: {
                          'User-Agent': CONFIG.userAgent
                      }
                  };

                  https.get(url, options, (res) => {
                      let data = '';
                      res.on('data', (chunk) => data += chunk);
                      res.on('end', () => {
                          // 清理 PHP 警告信息，只保留实际的 base64 内容
                          const cleanedData = data.replace(/<br \/>\n<b>.*?<\/b>.*?<br \/>\n/g, '').trim();
                          resolve(cleanedData);
                      });
                  }).on('error', reject)
                  .setTimeout(5000, () => {
                      reject(new Error('Request timeout'));
                  });
              });
          }

          async function fetchSubscription() {
              for (const domain of CONFIG.domains) {
                  try {
                      const url = `${domain}/subscribe/?uuid=${CONFIG.uuid}`;
                      console.log(`Trying to fetch from: ${url}`);
                      
                      const base64Content = await fetch(url);
                      
                      // 验证内容是否为有效的 base64
                      try {
                          const decoded = Buffer.from(base64Content, 'base64').toString();
                          if (!decoded.includes('vmess://') && !decoded.includes('hysteria2://')) {
                              throw new Error('Invalid subscription content');
                          }
                      } catch (error) {
                          console.error('Invalid base64 content or subscription format');
                          continue;
                      }
                      
                      // 确保输出目录存在
                      if (!fs.existsSync(CONFIG.outputDir)) {
                          fs.mkdirSync(CONFIG.outputDir, { recursive: true });
                      }
                      
                      // 写入文件
                      const outputPath = path.join(CONFIG.outputDir, CONFIG.outputFile);
                      fs.writeFileSync(outputPath, base64Content);
                      
                      console.log('Successfully fetched and saved subscription');
                      return;
                  } catch (error) {
                      console.error(`Failed to fetch from ${domain}:`, error.message);
                  }
              }
              throw new Error('All domains failed');
          }

          fetchSubscription().catch(error => {
              console.error('Failed to fetch subscription:', error);
              process.exit(1);
          });
          EOF

      - name: Create public directory
        run: mkdir -p public/subscribe
        
      - name: Run fetch script
        run: node fetch.js
        
      - name: Configure Git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
      - name: Commit and push if changed
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git add public/subscribe/subscription.txt
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update subscription $(date +'%Y-%m-%d %H:%M:%S')"
            git push origin HEAD:${GITHUB_REF#refs/heads/}
          fi
